generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Schools (white-label support)
model School {
  id           String   @id @default(cuid())
  name         String   // "Victory Heights Primary School"
  shortName    String   // "VHPS"
  city         String
  academicYear String   @default("2025/26") // e.g., "2025/26"
  brandColor   String   @default("#7f0029")
  accentColor  String   @default("#D4AF37")
  tagline      String?  // "Stay Connected" - displayed in header
  logoUrl      String?  // URL to school logo (login page)
  logoIconUrl  String?  // URL to header icon (48x48)
  paymentUrl   String?  // URL to payment portal (e.g., PayHub)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users               User[]
  yearGroups          YearGroup[]
  classes             Class[]
  students            Student[]
  messages            Message[]
  forms               Form[]
  events              Event[]
  termDates           TermDate[]
  scheduleItems       ScheduleItem[]
  weeklyMessages      WeeklyMessage[]
  knowledgeCategories KnowledgeCategory[]
  pulseSurveys        PulseSurvey[]
  policies            Policy[]
  folders             FileFolder[]
  files               SchoolFile[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  invitations         ParentInvitation[]
  linkCategories      LinkCategory[]
  externalLinks       ExternalLink[]
  groupCategories     GroupCategory[]
  groups              Group[]
  // ECA relations
  ecaSettings         EcaSettings?
  ecaTerms            EcaTerm[]
  ecaActivities       EcaActivity[]
}

// Users (Parents, Staff & Admins)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      Role     @default(PARENT)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])

  // OAuth fields
  googleId    String? @unique
  microsoftId String? @unique
  avatarUrl   String?

  // Password auth (for admin/staff)
  passwordHash String?

  // Language preference for translations (ISO 639-1 code)
  preferredLanguage String @default("en")

  // Parent relations
  children           Child[]
  studentLinks       ParentStudentLink[]

  // Staff relations - classes they can manage/message
  assignedClasses    StaffClassAssignment[]
  sentMessages       Message[]

  // Activity relations
  messageAcks        MessageAcknowledgment[]
  formResponses      FormResponse[]
  eventRsvps         EventRsvp[]
  pulseResponses     PulseResponse[]
  weeklyHearts       WeeklyMessageHeart[]
  refreshTokens      RefreshToken[]
  auditLogs          AuditLog[]
  notifications      Notification[]
  deviceTokens       DeviceToken[]

  // Invitation relations
  createdInvitations  ParentInvitation[] @relation("CreatedInvitations")
  redeemedInvitations ParentInvitation[] @relation("RedeemedInvitations")

  // Group management
  staffGroupAssignments StaffGroupAssignment[]

  // ECA relations
  ecaSelections        EcaSelection[] @relation("EcaSelections")
  ecaActivitiesManaged EcaActivity[]  @relation("EcaActivityStaff")
  ecaInvitationsSent   EcaInvitation[] @relation("EcaInvitationsSent")
  ecaAttendanceMarked  EcaAttendance[] @relation("EcaAttendanceMarkedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

enum Role {
  PARENT
  STAFF
  ADMIN
  SUPER_ADMIN
}

// Children linked to parents (deprecated - use Student + ParentStudentLink)
model Child {
  id       String @id @default(cuid())
  name     String
  parentId String
  parent   User   @relation(fields: [parentId], references: [id], onDelete: Cascade)
  classId  String
  class    Class  @relation(fields: [classId], references: [id])
}

// Students exist independently, managed by school admins
model Student {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  externalId  String?  // Optional: Student ID from school MIS
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  classId     String
  class       Class    @relation(fields: [classId], references: [id])

  parentLinks     ParentStudentLink[]
  invitationLinks StudentInvitationLink[]
  groupLinks      StudentGroupLink[]
  // ECA relations
  ecaSelections   EcaSelection[]
  ecaAllocations  EcaAllocation[]
  ecaWaitlists    EcaWaitlist[]
  ecaInvitations  EcaInvitation[]
  ecaAttendance   EcaAttendance[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([schoolId, externalId])
  @@index([schoolId, classId])
}

// Junction table: Parent-Student link
model ParentStudentLink {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId    String
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())

  @@unique([userId, studentId])
}

// Invitation references existing students
model StudentInvitationLink {
  id           String           @id @default(cuid())
  invitationId String
  invitation   ParentInvitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  studentId    String
  student      Student          @relation(fields: [studentId], references: [id])

  @@unique([invitationId, studentId])
}

// Year Groups
model YearGroup {
  id        String   @id @default(cuid())
  name      String   // "Reception", "Year 1", "Year 2"
  order     Int      // Sorting (0=Reception, 1=Year 1, etc.)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  classes   Class[]
  messages  Message[]
  events    Event[]
  scheduleItems ScheduleItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([schoolId, name])
}

// Classes/Year Groups
model Class {
  id          String  @id @default(cuid())
  name        String  // "FS1 Blue", "Y2 Red"
  colorBg     String  @default("bg-blue-500")
  colorText   String  @default("text-white")
  schoolId    String
  school      School  @relation(fields: [schoolId], references: [id])
  yearGroupId String?
  yearGroup   YearGroup? @relation(fields: [yearGroupId], references: [id])

  children             Child[]
  students             Student[]
  messages             Message[]
  events               Event[]
  scheduleItems        ScheduleItem[]
  assignedStaff        StaffClassAssignment[]
  childInvitationLinks ChildInvitationLink[]

  @@unique([schoolId, name])
}

// Staff-Class assignments (which classes a staff member can manage)
model StaffClassAssignment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, classId])
}

// Messages/Announcements
model Message {
  id          String   @id @default(cuid())
  title       String
  content     String
  targetClass String   // "Whole School" or class name
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id])
  yearGroupId String?
  yearGroup   YearGroup? @relation(fields: [yearGroupId], references: [id])
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id])
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  senderId    String
  sender      User     @relation(fields: [senderId], references: [id])
  senderName  String   // Kept for historical/backup, but sender.name is preferred

  // Action required
  actionType    String? // "consent", "payment", "rsvp"
  actionLabel   String?
  actionDueDate DateTime?
  actionAmount  String?

  // Message flags
  isPinned Boolean @default(false)
  isUrgent Boolean @default(false)

  // Lifecycle
  expiresAt DateTime? // Auto-archive after this date

  // Attached form
  formId  String? @unique
  form    Form?   @relation(fields: [formId], references: [id])

  acknowledgments MessageAcknowledgment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MessageAcknowledgment {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([messageId, userId])
}

// Events Calendar
model Event {
  id           String   @id @default(cuid())
  title        String
  description  String?
  date         DateTime
  time         String?
  location     String?
  targetClass  String
  classId      String?
  class        Class?   @relation(fields: [classId], references: [id])
  yearGroupId  String?
  yearGroup    YearGroup? @relation(fields: [yearGroupId], references: [id])
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  requiresRsvp Boolean  @default(false)

  rsvps EventRsvp[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventRsvp {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   // "attending", "not_attending", "maybe"
  createdAt DateTime @default(now())

  @@unique([eventId, userId])
}

// Term Dates
model TermDate {
  id       String    @id @default(cuid())
  term     Int
  termName String
  label    String
  sublabel String?
  date     DateTime
  endDate  DateTime?
  type     String    // "term-start", "term-end", "half-term", "public-holiday"
  color    String
  schoolId String
  school   School    @relation(fields: [schoolId], references: [id])
}

// Daily/Recurring Schedule
model ScheduleItem {
  id          String   @id @default(cuid())
  targetClass String
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id])
  yearGroupId String?
  yearGroup   YearGroup? @relation(fields: [yearGroupId], references: [id])
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])

  // For recurring items
  isRecurring Boolean @default(false)
  dayOfWeek   Int?    // 0-6 for recurring
  active      Boolean @default(true)

  // For one-off items
  date DateTime?

  type        String  // "pe", "swimming", "trip", "early-finish", etc.
  label       String
  description String?
  icon        String?

  createdAt DateTime @default(now())
}

// Weekly Principal Message
model WeeklyMessage {
  id        String   @id @default(cuid())
  title     String
  content   String
  weekOf    DateTime
  isCurrent Boolean  @default(false)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])

  hearts WeeklyMessageHeart[]

  createdAt DateTime @default(now())
}

model WeeklyMessageHeart {
  id        String        @id @default(cuid())
  messageId String
  message   WeeklyMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now())

  @@unique([messageId, userId])
}

// Knowledge Base
model KnowledgeCategory {
  id       String @id @default(cuid())
  name     String
  icon     String
  color    String
  order    Int    @default(0)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  articles KnowledgeArticle[]
}

model KnowledgeArticle {
  id         String            @id @default(cuid())
  title      String
  content    String
  categoryId String
  category   KnowledgeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  updatedAt  DateTime          @updatedAt
  createdAt  DateTime          @default(now())
}

// Parent Pulse Surveys
model PulseSurvey {
  id                    String   @id @default(cuid())
  halfTermName          String
  status                String   // "DRAFT", "OPEN", "CLOSED"
  opensAt               DateTime
  closesAt              DateTime
  additionalQuestionKey String?  // Key from OPTIONAL_QUESTIONS list
  schoolId              String
  school                School   @relation(fields: [schoolId], references: [id])

  responses PulseResponse[]

  createdAt DateTime @default(now())
}

model PulseResponse {
  id        String      @id @default(cuid())
  pulseId   String
  pulse     PulseSurvey @relation(fields: [pulseId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers   Json        // { q1: 4, q2: 5, ... }
  createdAt DateTime    @default(now())

  @@unique([pulseId, userId])
}

// School Policies
model Policy {
  id          String   @id @default(cuid())
  name        String   // e.g., "Attendance Policy", "Behaviour Policy"
  description String?
  fileUrl     String   // URL to the policy document (PDF)
  fileSize    Int?     // File size in bytes
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

// File Folders for organizing school files
model FileFolder {
  id          String   @id @default(cuid())
  name        String   // e.g., "Forms", "Letters", "Curriculum", "Photos"
  icon        String?  // Emoji or icon identifier
  color       String?  // Color for the folder
  parentId    String?  // For nested folders (null = root level)
  parent      FileFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    FileFolder[] @relation("FolderHierarchy")
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  files       SchoolFile[]
  order       Int      @default(0)
  createdAt   DateTime @default(now())
}

// School Files
model SchoolFile {
  id          String     @id @default(cuid())
  name        String     // Display name
  fileName    String     // Original file name
  fileUrl     String     // URL to the file
  fileType    String     // MIME type or extension (pdf, doc, jpg, etc.)
  fileSize    Int        // Size in bytes
  folderId    String?
  folder      FileFolder? @relation(fields: [folderId], references: [id])
  schoolId    String
  school      School     @relation(fields: [schoolId], references: [id])
  uploadedAt  DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Forms (replaces Surveys)
model Form {
  id           String   @id @default(cuid())
  title        String
  description  String?
  type         String   // template key: "permission-consent", "trip-consent", etc.
  status       String   @default("DRAFT") // "DRAFT", "ACTIVE", "CLOSED"
  fields       Json     // Array of field definitions
  targetClass  String   // Display label: "Whole School", "Y1 Red, Y2 Blue", etc.
  classIds     Json     @default("[]") // String[] of class IDs
  yearGroupIds Json     @default("[]") // String[] of year group IDs
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  expiresAt    DateTime?
  exportToken  String?  @unique // Secret token for public CSV export (Google Sheets IMPORTDATA)

  message   Message?

  responses FormResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FormResponse {
  id        String   @id @default(cuid())
  formId    String
  form      Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers   Json     // { fieldId: value }
  createdAt DateTime @default(now())

  @@unique([formId, userId])
}

// Parent Invitations (for self-registration)
model ParentInvitation {
  id             String   @id @default(cuid())
  schoolId       String
  school         School   @relation(fields: [schoolId], references: [id])

  accessCode     String   @unique  // ABC-123-XYZ format
  magicToken     String?  @unique  // For email magic links

  parentEmail    String?  // Optional: for magic link invites
  parentName     String?  // Optional: for display

  childLinks     ChildInvitationLink[]
  studentLinks   StudentInvitationLink[]

  status         String   @default("PENDING") // PENDING, REDEEMED, EXPIRED, REVOKED
  expiresAt      DateTime?
  redeemedAt     DateTime?
  redeemedByUserId String?
  redeemedByUser User?    @relation("RedeemedInvitations", fields: [redeemedByUserId], references: [id])

  createdById    String
  createdBy      User     @relation("CreatedInvitations", fields: [createdById], references: [id])
  createdAt      DateTime @default(now())

  @@index([schoolId, status])
  @@index([accessCode])
}

model ChildInvitationLink {
  id           String           @id @default(cuid())
  invitationId String
  invitation   ParentInvitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  childName    String
  classId      String
  class        Class            @relation(fields: [classId], references: [id])

  @@unique([invitationId, classId, childName])
}

// Audit Log
enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum AuditResourceType {
  MESSAGE
  SURVEY
  EVENT
  WEEKLY_MESSAGE
  TERM_DATE
  PULSE_SURVEY
  YEAR_GROUP
  CLASS
  STAFF
  STUDENT
  POLICY
  FILE
  FOLDER
  SCHEDULE_ITEM
  KNOWLEDGE_CATEGORY
  KNOWLEDGE_ARTICLE
  SCHOOL
  FORM
  PARENT_INVITATION
  GROUP
  GROUP_CATEGORY
  ECA_TERM
  ECA_ACTIVITY
  ECA_ALLOCATION
}

model AuditLog {
  id           String            @id @default(cuid())
  userId       String
  user         User              @relation(fields: [userId], references: [id])
  userName     String
  action       AuditAction
  resourceType AuditResourceType
  resourceId   String
  metadata     Json?
  schoolId     String
  school       School            @relation(fields: [schoolId], references: [id])
  ipAddress    String?
  createdAt    DateTime          @default(now())

  @@index([schoolId, createdAt])
  @@index([userId])
  @@index([resourceType])
}

// Notifications
model Notification {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String   // e.g. "MESSAGE", "EVENT", "SURVEY", "PULSE", "WEEKLY_MESSAGE"
  title        String
  body         String
  resourceType String?  // e.g. "MESSAGE", "EVENT"
  resourceId   String?
  data         Json?
  read         Boolean  @default(false)
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  createdAt    DateTime @default(now())

  @@index([userId, read, createdAt])
  @@index([schoolId])
}

// Device Tokens for push notifications
model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String
  platform  String   // "ios", "android", "web"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, token])
}

// Magic Link Tokens for passwordless authentication
model MagicLinkToken {
  id           String   @id @default(cuid())
  token        String   @unique
  email        String
  schoolId     String
  type         String   // "LOGIN" or "REGISTRATION"
  invitationId String?  // For registration flow, links to ParentInvitation
  expiresAt    DateTime
  usedAt       DateTime?
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([token])
}

// Link Categories for organizing external links
model LinkCategory {
  id          String         @id @default(cuid())
  name        String
  order       Int            @default(0)
  schoolId    String
  school      School         @relation(fields: [schoolId], references: [id])
  links       ExternalLink[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([schoolId, order])
}

// Group Category for organizing (Sports, Music, Clubs, etc.)
model GroupCategory {
  id        String   @id @default(cuid())
  name      String   // "Sports", "Music", "Clubs"
  icon      String?  // Emoji
  color     String?  // Hex color
  order     Int      @default(0)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])
  groups    Group[]
  ecaActivities EcaActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId, order])
}

// Main Group model (Teams, Clubs, etc.)
model Group {
  id          String         @id @default(cuid())
  name        String         // "U11 Football"
  description String?
  categoryId  String?
  category    GroupCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  schoolId    String
  school      School         @relation(fields: [schoolId], references: [id])
  isActive    Boolean        @default(true)

  studentMembers  StudentGroupLink[]
  staffManagers   StaffGroupAssignment[]
  messages        Message[]
  events          Event[]
  ecaActivity     EcaActivity?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId, isActive])
}

// Student membership in groups
model StudentGroupLink {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  role      String?  // Optional: "captain", "member"
  joinedAt  DateTime @default(now())

  @@unique([studentId, groupId])
}

// Staff assignment to manage groups
model StaffGroupAssignment {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId    String
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  canMessage Boolean  @default(true)
  canManage  Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@unique([userId, groupId])
}

// External Links for parents
model ExternalLink {
  id          String        @id @default(cuid())
  title       String
  description String?
  url         String
  icon        String?       // Emoji or icon name
  imageUrl    String?       // URL to logo/image
  order       Int           @default(0)
  active      Boolean       @default(true)
  categoryId  String?
  category    LinkCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  schoolId    String
  school      School        @relation(fields: [schoolId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([schoolId, active, order])
  @@index([categoryId])
}

// ============================================
// ECA (Extra-Curricular Activities) Module
// ============================================

// School-level ECA settings
model EcaSettings {
  id                    String   @id @default(cuid())
  schoolId              String   @unique
  school                School   @relation(fields: [schoolId], references: [id])
  selectionMode         EcaSelectionMode @default(FIRST_COME_FIRST_SERVED)
  attendanceEnabled     Boolean  @default(false)
  maxPriorityChoices    Int      @default(1)  // Priority ECAs per week
  maxChoicesPerDay      Int      @default(3)  // Ranked choices per slot
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

enum EcaSelectionMode {
  FIRST_COME_FIRST_SERVED
  SMART_ALLOCATION
}

// ECA Term - registration windows and time slots per term
model EcaTerm {
  id                       String   @id @default(cuid())
  schoolId                 String
  school                   School   @relation(fields: [schoolId], references: [id])
  name                     String   // "Term 1 2025/26"
  termNumber               Int      // 1, 2, 3
  academicYear             String   // "2025/26"
  startDate                DateTime
  endDate                  DateTime
  registrationOpens        DateTime
  registrationCloses       DateTime
  defaultBeforeSchoolStart String?  // "07:30"
  defaultBeforeSchoolEnd   String?  // "08:15"
  defaultAfterSchoolStart  String?  // "15:30"
  defaultAfterSchoolEnd    String?  // "16:30"
  status                   EcaTermStatus @default(DRAFT)
  allocationRun            Boolean  @default(false)
  activities               EcaActivity[]
  selections               EcaSelection[]
  allocations              EcaAllocation[]
  waitlists                EcaWaitlist[]
  attendanceRecords        EcaAttendance[]
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@unique([schoolId, termNumber, academicYear])
  @@index([schoolId, status])
}

enum EcaTermStatus {
  DRAFT               // Setup phase
  REGISTRATION_OPEN   // Parents can submit
  REGISTRATION_CLOSED // Waiting for allocation
  ALLOCATION_COMPLETE // Results published
  ACTIVE              // Term in progress
  COMPLETED           // Term ended
}

// ECA Activity - individual activity offering
model EcaActivity {
  id                   String   @id @default(cuid())
  ecaTermId            String
  ecaTerm              EcaTerm  @relation(fields: [ecaTermId], references: [id], onDelete: Cascade)
  schoolId             String
  school               School   @relation(fields: [schoolId], references: [id])
  name                 String   // "Football Club"
  description          String?
  groupId              String?  @unique  // Auto-created group
  group                Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  categoryId           String?
  category             GroupCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  dayOfWeek            Int      // 0=Sun, 1=Mon, etc.
  timeSlot             EcaTimeSlot
  customStartTime      String?  // Override default
  customEndTime        String?
  location             String?
  activityType         EcaActivityType @default(OPEN)
  eligibleYearGroupIds Json     @default("[]")  // String[]
  eligibleGender       EcaGender @default(MIXED)
  minCapacity          Int?
  maxCapacity          Int?
  staffId              String?
  staff                User?    @relation("EcaActivityStaff", fields: [staffId], references: [id])
  isActive             Boolean  @default(true)
  isCancelled          Boolean  @default(false)
  cancelReason         String?
  selections           EcaSelection[]
  allocations          EcaAllocation[]
  waitlists            EcaWaitlist[]
  invitations          EcaInvitation[]
  attendanceRecords    EcaAttendance[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([ecaTermId, dayOfWeek, timeSlot])
  @@index([schoolId, isActive])
}

enum EcaTimeSlot {
  BEFORE_SCHOOL
  AFTER_SCHOOL
}

enum EcaActivityType {
  OPEN
  INVITE_ONLY
  COMPULSORY
  TRYOUT
}

enum EcaGender {
  MIXED
  BOYS_ONLY
  GIRLS_ONLY
}

// Parent selections during registration
model EcaSelection {
  id            String   @id @default(cuid())
  ecaTermId     String
  ecaTerm       EcaTerm  @relation(fields: [ecaTermId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentUserId  String
  parentUser    User     @relation("EcaSelections", fields: [parentUserId], references: [id], onDelete: Cascade)
  ecaActivityId String
  ecaActivity   EcaActivity @relation(fields: [ecaActivityId], references: [id], onDelete: Cascade)
  rank          Int      @default(1)  // 1=first choice
  isPriority    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([ecaTermId, studentId, ecaActivityId])
  @@index([ecaTermId, studentId])
}

// Final allocations after algorithm runs
model EcaAllocation {
  id              String   @id @default(cuid())
  ecaTermId       String
  ecaTerm         EcaTerm  @relation(fields: [ecaTermId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  ecaActivityId   String
  ecaActivity     EcaActivity @relation(fields: [ecaActivityId], references: [id], onDelete: Cascade)
  allocationType  EcaAllocationType
  allocationRound Int?
  status          EcaAllocationStatus @default(CONFIRMED)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([ecaTermId, studentId, ecaActivityId])
  @@index([ecaTermId, studentId])
}

enum EcaAllocationType {
  FIRST_COME
  SMART_PRIORITY
  SMART_RANKED
  SMART_REALLOCATION
  INVITED
  COMPULSORY
  MANUAL
}

enum EcaAllocationStatus {
  CONFIRMED
  WITHDRAWN
  REMOVED
}

// Waitlist for full activities
model EcaWaitlist {
  id            String   @id @default(cuid())
  ecaTermId     String
  ecaTerm       EcaTerm  @relation(fields: [ecaTermId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  ecaActivityId String
  ecaActivity   EcaActivity @relation(fields: [ecaActivityId], references: [id], onDelete: Cascade)
  position      Int
  createdAt     DateTime @default(now())

  @@unique([ecaTermId, studentId, ecaActivityId])
  @@index([ecaActivityId, position])
}

// Invitations for invite-only/tryout activities
model EcaInvitation {
  id            String   @id @default(cuid())
  ecaActivityId String
  ecaActivity   EcaActivity @relation(fields: [ecaActivityId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  status        EcaInvitationStatus @default(PENDING)
  invitedById   String
  invitedBy     User     @relation("EcaInvitationsSent", fields: [invitedById], references: [id])
  isTryout      Boolean  @default(false)
  tryoutResult  EcaTryoutResult?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([ecaActivityId, studentId])
}

enum EcaInvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum EcaTryoutResult {
  SUCCESSFUL
  UNSUCCESSFUL
  PENDING
}

// Attendance tracking (optional)
model EcaAttendance {
  id            String   @id @default(cuid())
  ecaTermId     String
  ecaTerm       EcaTerm  @relation(fields: [ecaTermId], references: [id], onDelete: Cascade)
  ecaActivityId String
  ecaActivity   EcaActivity @relation(fields: [ecaActivityId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sessionDate   DateTime
  status        EcaAttendanceStatus
  note          String?
  markedById    String?
  markedBy      User?    @relation("EcaAttendanceMarkedBy", fields: [markedById], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([ecaActivityId, studentId, sessionDate])
  @@index([ecaActivityId, sessionDate])
}

enum EcaAttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}
